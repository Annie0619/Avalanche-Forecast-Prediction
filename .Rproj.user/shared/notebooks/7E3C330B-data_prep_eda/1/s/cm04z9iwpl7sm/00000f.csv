"0","set.seed(123)"
"0",""
"0","# --- (B) Time-aware split (no leakage) ---"
"0","aval <- aval %>% arrange(Date) # ensure dataset is sorted chronologically"
"0","split  <- initial_time_split(aval, prop = 0.8)  # last ~20% becomes test by time and the first 80% become the training set"
"0","train  <- training(split)"
"0","test   <- testing(split)"
"0",""
"0","# --- (C) Bagged-tree imputation recipe ---"
"0","rec_bagged <- recipe(FAH_ord ~ ., data = train) %>%"
"0","  # Drop pure IDs / text fields from predictors (won't be used by the model)"
"0","  update_role(any_of(c(""DateTime"",""OSgrid"",""Location"",""site_id"")), new_role = ""id"") %>%"
"0","  step_rm(any_of(c(""DateTime"",""OSgrid"",""Location"",""site_id""))) %>%"
"0",""
"0","  # remove these because we transformed them:"
"0","  step_rm(any_of(c(""Wind.Dir"",""Summit.Wind.Dir"",""Aspect""))) %>%"
"0",""
"0","  # Bagged trees for numeric predictors (exclude the 0/1 missing flags)"
"0","  step_impute_bag(all_numeric_predictors(), -matches(""_missing$"")) %>%"
"0",""
"0","  # Mode imputation for categorical predictors (factors/character)"
"0","  step_impute_mode(all_nominal_predictors()) %>%"
"0",""
"0","  # Normalize numeric predictors for NN stability, but NOT the 0/1 flags"
"0","  step_normalize(all_numeric_predictors(), -matches(""_missing$"")) %>%"
"0",""
"0","  # Remove zero-variance columns that can appear after imputation/normalization"
"0","  step_zv(all_predictors())"
"0",""
"0","# --- (D) Prep on TRAIN only; bake TRAIN/TEST ---"
"0","prep_bagged <- prep(rec_bagged, training = train, retain = TRUE)"
"0",""
"0","train_ready <- bake(prep_bagged, new_data = NULL)  # training set baked"
"0","test_ready  <- bake(prep_bagged, new_data = test)  # test set baked"
"0",""
"0","# --- (E) Quick checks ---"
"0","# No NA's left in predictors?"
"0","sapply(select(train_ready, -FAH_ord), \(x) sum(is.na(x))) %>% sum()"
"1","[1]"
"1"," 0"
"1","
"
"0","# Indicators remain 0/1 and were not normalized?"
"0","summary(select(train_ready, ends_with(""_missing"")))"
"1","< table of extent"
"1"," "
"1","0 x 0"
"1"," "
"1",">
"
